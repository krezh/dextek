apiVersion: v1
kind: Secret
metadata:
  name: ubuntu-runner-cloudinit
  namespace: actions-runner-system
type: Opaque
stringData:
  userdata: |
    #cloud-config
    users:
      - name: runner
        groups: sudo
        shell: /bin/bash
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
    packages:
      - curl
      - jq
      - tar
      - openssl
    mounts:
      - [ runner-info, /runner-info/, virtiofs, "rw,relatime" ]

    write_files:
      - path: /opt/runner/setup.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/bash
          set -euo pipefail

          mkdir -p /opt/runner
          cd /opt/runner

          # Mount GitHub App credentials secret by serial number
          echo "Mounting GitHub App credentials..."
          mkdir -p /mnt/github-app-creds
          SECRET_DEV=$(lsblk -o NAME,SERIAL -p -n | grep GHCREDS001 | awk '{print $1}')

          if [ -z "$SECRET_DEV" ]; then
            echo "ERROR: Could not find secret device with serial GHCREDS001"
            exit 1
          fi

          echo "Found secret device: $SECRET_DEV"
          mount -t iso9660 "$SECRET_DEV" /mnt/github-app-creds

          echo "Listing mounted secret contents:"
          ls -la /mnt/github-app-creds/

          # Read GitHub App credentials
          GITHUB_APP_ID=$(cat /mnt/github-app-creds/github_app_id)
          GITHUB_APP_INSTALLATION_ID=$(cat /mnt/github-app-creds/github_app_installation_id)
          GITHUB_APP_PRIVATE_KEY=$(cat /mnt/github-app-creds/github_app_private_key)

          echo "GitHub App ID: ${GITHUB_APP_ID}"
          echo "GitHub App Installation ID: ${GITHUB_APP_INSTALLATION_ID}"
          echo "Generating GitHub App installation token..."

          # Base64 URL-safe encoder (no padding)
          b64enc() { openssl enc -base64 -A | tr '+/' '-_' | tr -d '='; }
          NOW=$(date +%s)
          HEADER=$(printf '{"alg":"RS256","typ":"JWT"}' | jq -r -c .)
          PAYLOAD=$(printf '{"exp":%s,"iat":%s,"iss":"%s"}' "$((NOW + 590))" "$((NOW - 10))" "${GITHUB_APP_ID}" | jq -r -c .)
          SIGNED_CONTENT=$(printf '%s' "${HEADER}" | b64enc).$(printf '%s' "${PAYLOAD}" | b64enc)

          # Write private key to a secure temp file (avoid process substitution)
          keyfile=$(mktemp)
          printf '%s\n' "$GITHUB_APP_PRIVATE_KEY" > "$keyfile"
          chmod 600 "$keyfile"

          SIG=$(printf '%s' "${SIGNED_CONTENT}" | openssl dgst -binary -sha256 -sign "$keyfile" | b64enc)
          rm -f "$keyfile"

          JWT="${SIGNED_CONTENT}.${SIG}"

          TOKEN_RESPONSE=$(curl -s --request POST \
            "https://api.github.com/app/installations/${GITHUB_APP_INSTALLATION_ID}/access_tokens" \
            --header "Authorization: Bearer $JWT" \
            --header 'Accept: application/vnd.github+json' \
            --header 'X-GitHub-Api-Version: 2022-11-28')

          GITHUB_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.token')
          if [ -z "$GITHUB_TOKEN" ] || [ "$GITHUB_TOKEN" = "null" ]; then
            echo "ERROR: Failed to generate installation token"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi

          echo "Successfully generated installation token"
          echo "Using authenticated API request to get runner version..."
          RUNNER_VERSION=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" https://api.github.com/repos/actions/runner/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          if [ -z "$RUNNER_VERSION" ] || [ "$RUNNER_VERSION" = "null" ]; then
            echo "ERROR: Failed to fetch runner version; using fallback"
            RUNNER_VERSION="2.330.0"
          fi

          echo "Runner version: $RUNNER_VERSION"

          curl -L -o actions-runner-linux-x64.tar.gz "https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz"
          tar xzf actions-runner-linux-x64.tar.gz
          chown -R runner:runner /opt/runner
          rm actions-runner-linux-x64.tar.gz

          echo "Starting runner..."
          sudo -u runner bash -c 'cd /opt/runner && ./run.sh --jitconfig $(jq -r ".jitconfig" /runner-info/runner-info.json)'

    runcmd:
      - ['bash', '/opt/runner/setup.sh']
      - sleep 30

    power_state:
      delay: now
      mode: poweroff
      message: Runner completed
      timeout: 2
      condition: true
