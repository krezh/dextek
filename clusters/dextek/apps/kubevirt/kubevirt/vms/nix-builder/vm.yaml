# ---
# # yaml-language-server: $schema=https://kubernetes-schemas.plexuz.xyz/kubevirt.io/virtualmachine_v1.json
# apiVersion: kubevirt.io/v1
# kind: VirtualMachine
# metadata:
#   name: nix-builder
# spec:
#   runStrategy: Manual # Options: Always | Manual | RerunOnFailure | Halted
#   template:
#     metadata:
#       labels:
#         kubevirt.io/vm: nix-builder
#       annotations:
#         kubevirt.io/allow-pod-bridge-network-live-migration: "true"
#     spec:
#       evictionStrategy: LiveMigrate
#       domain:
#         resources:
#           requests:
#             cpu: 8
#             memory: 8G
#         devices:
#           disks:
#             - name: nix-builder-pvc
#               disk:
#                 bus: virtio
#             - name: cloudinitdisk
#               disk:
#                 bus: virtio
#           interfaces:
#             - name: default
#               masquerade: {}
#       networks:
#         - name: default
#           pod: {}
#       volumes:
#         - name: nix-builder-pvc
#           persistentVolumeClaim:
#             claimName: fedora-base-image
#         - name: cloudinitdisk
#           cloudInitNoCloud:
#             userData: |-
#               #cloud-config
#               users:
#                 - name: root
#                 - name: cloud-user
#                   sudo: ['ALL=(ALL) NOPASSWD:ALL']
#                   groups: sudo
#                   shell: /bin/bash
---
# yaml-language-server: $schema=https://kubernetes-schemas.plexuz.xyz/pool.kubevirt.io/virtualmachinepool_v1alpha1.json
apiVersion: pool.kubevirt.io/v1alpha1
kind: VirtualMachinePool
metadata:
  name: nix-builder-pool
spec:
  replicas: 3
  selector:
    matchLabels:
      kubevirt.io/vmpool: nix-builder-pool
  virtualMachineTemplate:
    metadata:
      labels:
        ubevirt.io/vmpool: nix-builder-pool
      annotations:
        kubevirt.io/allow-pod-bridge-network-live-migration: "true"
    spec:
      runStrategy: Always # Options: Always | Manual | RerunOnFailure | Halted
      template:
        metadata:
          labels:
            kubevirt.io/vmpool: nix-builder-pool
        spec:
          domain:
            resources:
              requests:
                cpu: 8
                memory: 8G
            devices:
              disks:
                - name: nix-builder-pvc
                  disk:
                    bus: virtio
                - name: cloudinitdisk
                  disk:
                    bus: virtio
              interfaces:
                - name: default
                  masquerade: {}
          networks:
            - name: default
              pod: {}
          volumes:
            - name: nix-builder-pvc
              persistentVolumeClaim:
                claimName: fedora-base-image
            - name: cloudinitdisk
              cloudInitNoCloud:
                userData: |-
                  #cloud-config
                  users:
                    - name: root
                    - name: cloud-user
                      sudo: ['ALL=(ALL) NOPASSWD:ALL']
                      groups: sudo
                      shell: /bin/bash
