---
# yaml-language-server: $schema=https://kubernetes-schemas.plexuz.xyz/pool.kubevirt.io/virtualmachinepool_v1alpha1.json
apiVersion: pool.kubevirt.io/v1alpha1
kind: VirtualMachinePool
metadata:
  name: buildbot-nix-master-pool
spec:
  replicas: 1
  selector:
    matchLabels:
      kubevirt.io/vmpool: buildbot-nix-master-pool
  virtualMachineTemplate:
    metadata:
      labels:
        kubevirt.io/vmpool: buildbot-nix-master-pool
      annotations:
        kubevirt.io/allow-pod-bridge-network-live-migration: "true"
    spec:
      dataVolumeTemplates:
        - metadata:
            name: buildbot-nix-master-pvc
          spec:
            pvc:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 100Gi
              storageClassName: ceph-block
            source:
              pvc:
                namespace: kubevirt
                name: buildbot-nix-master-image
      runStrategy: Always # Options: Always | Manual | RerunOnFailure | Halted
      template:
        metadata:
          labels:
            kubevirt.io/vmpool: buildbot-nix-master-pool
        spec:
          domain:
            resources:
              requests:
                memory: 4Gi
            devices:
              disks:
                - name: buildbot-nix-master-pvc
                  disk:
                    bus: virtio
                - name: cloudinitdisk
                  disk:
                    bus: virtio
                - name: age-secret-disk
                  disk: {}
                  serial: AGEKEY123
              interfaces:
                - name: default
                  masquerade: {}
          networks:
            - name: default
              pod: {}
          volumes:
            - name: buildbot-nix-master-pvc
              dataVolume:
                name: buildbot-nix-master-pvc
            - name: age-secret-disk
              secret:
                secretName: buildbot-age-key
            - name: cloudinitdisk
              cloudInitNoCloud:
                userData: |-
                  #cloud-config
                  users:
                    - name: root
                    - name: cloud-user
                      sudo: ['ALL=(ALL) NOPASSWD:ALL']
                      groups: sudo
                      shell: /bin/bash
                  bootcmd:
                    - mkdir -p /var/lib/sops-nix
                    - mkdir -p /mnt/age-secret
                    - mount /dev/$(lsblk --nodeps -no name,serial | grep AGEKEY123 | cut -f1 -d' ') /mnt/age-secret
                    - cp /mnt/age-secret/key.txt /var/lib/sops-nix/key.txt
                    - chmod 600 /var/lib/sops-nix/key.txt
                    - umount /mnt/age-secret
                  runcmd:
                    - |
                      if [ ! -f /var/lib/cloud/initial-config-done ]; then
                        /run/current-system/sw/bin/nixos-rebuild switch --flake github:krezh/nix-config#buildbot-master --accept-flake-config 2>&1 | tee /var/log/initial-nixos-rebuild.log
                        touch /var/lib/cloud/initial-config-done
                      fi
