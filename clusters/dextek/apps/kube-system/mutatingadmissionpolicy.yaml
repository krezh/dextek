---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicybinding-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: remove-cpu-limits
spec:
  policyName: remove-cpu-limits
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicy-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: remove-cpu-limits
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - ""
        apiVersions:
          - v1
        operations:
          - CREATE
          - UPDATE
        resources:
          - pods
  matchConditions:
    - name: has-cpu-limits
      expression: >-
        object.spec.containers.exists(c,
          has(c.resources) && has(c.resources.limits) && "cpu" in c.resources.limits
        )
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >-
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].filter(i,
            i < object.spec.containers.size() &&
            has(object.spec.containers[i].resources) &&
            has(object.spec.containers[i].resources.limits) &&
            "cpu" in object.spec.containers[i].resources.limits
          ).map(i,
            JSONPatch{
              op: "remove",
              path: "/spec/containers/" + string(i) + "/resources/limits/cpu"
            }
          )
