---
# yaml-language-server: $schema=https://kubernetes-schemas.plexuz.xyz/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: forgejo-db
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: crunchy-pgo-secrets
  target:
    name: forgejo-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database configuration
        FORGEJO__database__DB_TYPE: "postgres"
        FORGEJO__database__HOST: '{{ index . "host" }}'
        FORGEJO__database__NAME: '{{ index . "dbname" }}'
        FORGEJO__database__USER: '{{ index . "user" }}'
        FORGEJO__database__PASSWD: '{{ index . "password" }}'
        FORGEJO__database__LOG_SQL: "false"
        FORGEJO__database__SLOW_QUERY_THRESHOLD: "5s"

        # Postgres init variables
        INIT_POSTGRES_HOST: '{{ index . "host" }}'
        INIT_POSTGRES_DBNAME: '{{ index . "dbname" }}'
        INIT_POSTGRES_USER: '{{ index . "user" }}'
        INIT_POSTGRES_PASS: '{{ index . "password" }}'

        # Server configuration
        FORGEJO__server__DOMAIN: "git.plexuz.xyz"
        FORGEJO__server__ROOT_URL: "https://git.plexuz.xyz"
        FORGEJO__server__HTTP_PORT: "3000"
        FORGEJO__server__APP_DATA_PATH: "/data/gitea"
        FORGEJO__server__DISABLE_SSH: "false"
        FORGEJO__server__SSH_DOMAIN: "git.talos.plexuz.xyz"
        FORGEJO__server__SSH_PORT: "22"
        FORGEJO__server__SSH_LISTEN_PORT: "22"
        FORGEJO__server__START_SSH_SERVER: "true"
        FORGEJO__server__ENABLE_GZIP: "true"
        FORGEJO__server__LFS_START_SERVER: "true"
        FORGEJO__server__OFFLINE_MODE: "false"
        FORGEJO__server__LANDING_PAGE: "explore"

        # Indexer configuration
        FORGEJO__indexer__REPO_INDEXER_ENABLED: "true"
        FORGEJO__indexer__REPO_INDEXER_REPO_TYPES: "sources,forks,mirrors,templates"
        FORGEJO__indexer__ISSUE_INDEXER_TYPE: "db"

        # Queue configuration (using Dragonfly)
        FORGEJO__queue__TYPE: "redis"
        FORGEJO__queue__CONN_STR: "redis://dragonfly.databases.svc.cluster.local:6379/5"

        # Security configuration
        FORGEJO__security__INSTALL_LOCK: "true"
        FORGEJO__security__PASSWORD_HASH_ALGO: "argon2"
        FORGEJO__security__PASSWORD_COMPLEXITY: "lower,upper,digit,spec"
        FORGEJO__security__PASSWORD_CHECK_PWN: "true"
        FORGEJO__security__MIN_PASSWORD_LENGTH: "12"
        FORGEJO__security__REVERSE_PROXY_LIMIT: "1"

        # Service configuration
        FORGEJO__service__DISABLE_REGISTRATION: "false"
        FORGEJO__service__REGISTER_EMAIL_CONFIRM: "true"
        FORGEJO__service__ENABLE_NOTIFY_MAIL: "true"
        FORGEJO__service__ENABLE_CAPTCHA: "true"
        FORGEJO__service__REQUIRE_CAPTCHA_FOR_LOGIN: "true"
        FORGEJO__service__REQUIRE_EXTERNAL_REGISTRATION_CAPTCHA: "true"
        FORGEJO__service__CAPTCHA_TYPE: "cfturnstile"
        FORGEJO__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
        FORGEJO__service__DEFAULT_ALLOW_CREATE_ORGANIZATION: "true"
        FORGEJO__service__DEFAULT_ENABLE_TIMETRACKING: "true"
        FORGEJO__service__ENABLE_USER_HEATMAP: "true"
        FORGEJO__service__AUTO_WATCH_NEW_REPOS: "true"
        FORGEJO__service__SHOW_REGISTRATION_BUTTON: "true"
        FORGEJO__service__VALID_SITE_URL_SCHEMES: "https"
        FORGEJO__service__EXPLORE.REQUIRE_SIGNIN_VIEW: "false"

        # QoS configuration
        FORGEJO__qos__ENABLED: "true"

        # Mailer configuration
        FORGEJO__mailer__ENABLED: "false"
        FORGEJO__mailer__PROTOCOL: "smtp+starttls"
        FORGEJO__mailer__SMTP_PORT: "587"
        FORGEJO__mailer__FROM: "admin@plexuz.xyz"

        # Cache configuration (using Dragonfly)
        FORGEJO__cache__ADAPTER: "redis"
        FORGEJO__cache__HOST: "redis://dragonfly.databases.svc.cluster.local:6379/5"

        # Session configuration (using Dragonfly)
        FORGEJO__session__PROVIDER: "redis"
        FORGEJO__session__PROVIDER_CONFIG: "redis://dragonfly.databases.svc.cluster.local:6379/5"
        FORGEJO__session__COOKIE_SECURE: "true"
        FORGEJO__session__DOMAIN: "git.plexuz.xyz"
        FORGEJO__session__COOKIE_NAME: "forgejo_session"
        FORGEJO__session__SESSION_LIFE_TIME: "86400"
        FORGEJO__session__SAME_SITE: "lax"

        # Cron configuration
        FORGEJO__cron__ENABLED: "true"
        FORGEJO__cron.git_gc_repos__ENABLED: "true"
        FORGEJO__cron.git_gc_repos__SCHEDULE: "@every 168h"
        FORGEJO__cron.git_gc_repos__TIMEOUT: "60s"
        FORGEJO__cron.git_gc_repos__ARGS: "--aggressive --auto"
        FORGEJO__cron.update_mirrors__SCHEDULE: "@every 10m"
        FORGEJO__cron.update_mirrors__PULL_LIMIT: "50"
        FORGEJO__cron.update_mirrors__PUSH_LIMIT: "50"
        FORGEJO__cron.cleanup_actions__ENABLED: "true"
        FORGEJO__cron.cleanup_actions__SCHEDULE: "@midnight"

        # Metrics configuration
        FORGEJO__metrics__ENABLED: "true"

        # Time configuration
        FORGEJO__time__DEFAULT_UI_LOCATION: "Europe/Stockholm"

        # Federation configuration
        FORGEJO__federation__ENABLED: "true"

        # UI configuration
        FORGEJO__ui__DEFAULT_THEME: "forgejo-auto"
        FORGEJO__ui__SHOW_USER_EMAIL: "false"
        FORGEJO__ui__AMBIGUOUS_UNICODE_DETECTION: "true"
        FORGEJO__ui__DEFAULT_SHOW_FULL_NAME: "true"
        FORGEJO__ui__FEED_MAX_COMMIT_NUM: "10"
        FORGEJO__ui__GRAPH_MAX_COMMIT_NUM: "100"

        # Markdown configuration
        FORGEJO__markdown__ENABLE_HARD_LINE_BREAK_IN_COMMENTS: "true"
        FORGEJO__markdown__ENABLE_MATH: "true"

        # Webhook configuration
        FORGEJO__webhook__ALLOWED_HOST_LIST: "external"
        FORGEJO__webhook__SKIP_TLS_VERIFY: "false"
        FORGEJO__webhook__DELIVER_TIMEOUT: "10"

        # Migrations configuration
        FORGEJO__migrations__ALLOW_LOCALNETWORKS: "true"
        FORGEJO__migrations__ALLOWED_DOMAINS: "*"

        # API configuration
        FORGEJO__api__ENABLE_SWAGGER: "true"
        FORGEJO__api__MAX_RESPONSE_ITEMS: "50"
        FORGEJO__api__DEFAULT_PAGING_NUM: "30"

        # Git configuration
        FORGEJO__git__DISABLE_DIFF_HIGHLIGHT: "false"
        FORGEJO__git__MAX_GIT_DIFF_LINES: "1000"
        FORGEJO__git__MAX_GIT_DIFF_FILES: "100"
        FORGEJO__git__ENABLE_AUTO_GIT_WIRE_PROTOCOL: "true"
        FORGEJO__git__PULL_REQUEST_PUSH_MESSAGE: "true"
        FORGEJO__git__VERBOSE_PUSH: "true"
        FORGEJO__git.timeout__MIGRATE: "3000"
        FORGEJO__git.timeout__MIRROR: "3000"

        # Actions configuration
        FORGEJO__actions__ENABLED: "true"
        FORGEJO__actions__DEFAULT_ACTIONS_URL: "https://github.com"
        FORGEJO__actions__ARTIFACT_RETENTION_DAYS: "90"
        FORGEJO__actions__LOG_RETENTION_DAYS: "365"
        FORGEJO__actions__LOG_COMPRESSION: "zstd"

        # Repository configuration
        FORGEJO__repository__DEFAULT_BRANCH: "main"
        FORGEJO__repository__ENABLE_PUSH_CREATE_USER: "true"
        FORGEJO__repository__DISABLE_HTTP_GIT: "false"
        FORGEJO__repository__DEFAULT_PRIVATE: "last"
  dataFrom:
    - extract:
        key: postgres-pguser-forgejo
---
# yaml-language-server: $schema=https://kubernetes-schemas.plexuz.xyz/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: forgejo-oauth
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: doppler
  target:
    name: forgejo-oauth-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # OpenID configuration for Authentik
        FORGEJO__openid__ENABLE_OPENID_SIGNIN: "true"
        FORGEJO__openid__ENABLE_OPENID_SIGNUP: "true"
        FORGEJO_OAUTH_NAME: "authentik"
        FORGEJO_OAUTH_PROVIDER: "openidConnect"
        FORGEJO_OAUTH_CLIENT_ID: "{{ .FORGEJO_OAUTH_CLIENT_ID }}"
        FORGEJO_OAUTH_CLIENT_SECRET: "{{ .FORGEJO_OAUTH_CLIENT_SECRET }}"
        FORGEJO_OAUTH_AUTO_DISCOVER_URL: "https://sso.plexuz.xyz/application/o/forgejo/.well-known/openid-configuration"
        FORGEJO_OAUTH_SCOPES: "openid email profile groups"
        FORGEJO_OAUTH_GROUP_CLAIM_NAME: "groups"
        FORGEJO_OAUTH_ADMIN_GROUP: "forgejo_admins"
        FORGEJO_OAUTH_ICON_URL: "https://sso.plexuz.xyz/static/dist/assets/icons/icon.svg"
  dataFrom:
    - extract:
        key: FORGEJO
